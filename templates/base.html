<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MCP Demo - Model Context Protocol{% endblock %}</title>
    
    <!-- Custom CSS - Our minimalist design system -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    
    <!-- Bootstrap Icons only -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    
    {% block extra_css %}{% endblock %}
</head>
<body class="app-container">
    <!-- Simple Header -->
    <header class="nav-header">
        <nav class="nav-container">
            <a href="/" class="nav-brand">
                <i class="bi bi-plugin"></i>
                MCP Demo
            </a>
            
            <div class="nav-actions">
                <!-- Connection Status -->
                <div class="status-indicator status-online" id="connectionStatus">
                    <i class="bi bi-circle-fill"></i>
                    <span>Connected</span>
                </div>
                
                <!-- Theme Toggle -->
                <button class="theme-toggle" id="themeToggle" title="Toggle theme">
                    <i class="bi bi-sun" id="themeIcon"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="toast-container" id="flashMessages">
                    {% for category, message in messages %}
                        <div class="toast {{ category }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <!-- Toast Container for JavaScript notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    
    <!-- Base JavaScript -->
    <script>
        // Initialize Socket.IO
        const socket = io();
        
        // Connection status handling
        socket.on('connect', function() {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.innerHTML = '<i class="bi bi-circle-fill"></i><span>Connected</span>';
            statusEl.className = 'status-indicator status-online';
        });
        
        socket.on('disconnect', function() {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.innerHTML = '<i class="bi bi-circle"></i><span>Disconnected</span>';
            statusEl.className = 'status-indicator status-offline';
        });
        
        // Theme toggle functionality
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const htmlElement = document.documentElement;
        
        // Check for saved theme preference or default to dark
        const savedTheme = localStorage.getItem('theme') || 'dark';
        htmlElement.setAttribute('data-bs-theme', savedTheme);
        updateThemeIcon(savedTheme);
        
        themeToggle.addEventListener('click', function() {
            const currentTheme = htmlElement.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            htmlElement.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        });
        
        function updateThemeIcon(theme) {
            if (theme === 'dark') {
                themeIcon.className = 'bi bi-sun';
            } else {
                themeIcon.className = 'bi bi-moon-stars';
            }
        }
        
        // Helper function for API calls
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(endpoint, options);
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'API call failed');
            }
            
            return result;
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast ${type} animate-fade-in`;
            
            toast.innerHTML = `
                <div class="flex justify-between items-center">
                    <span>${message}</span>
                    <button class="btn-ghost btn-sm ml-3" onclick="this.parentElement.parentElement.remove()">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }
        
        // Auto-hide flash messages
        document.addEventListener('DOMContentLoaded', function() {
            const flashContainer = document.getElementById('flashMessages');
            if (flashContainer) {
                setTimeout(() => {
                    flashContainer.style.opacity = '0';
                    setTimeout(() => flashContainer.remove(), 300);
                }, 4000);
            }
        });
        
        // Enhanced fetch with error handling
        async function fetchWithErrorHandling(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                showToast('Network error: ' + error.message, 'error');
                throw error;
            }
        }
        
        // Utility function to format dates
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        // Utility function to format relative time
        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));
            
            if (diffInMinutes < 1) return 'Just now';
            if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `${diffInHours}h ago`;
            
            const diffInDays = Math.floor(diffInHours / 24);
            return `${diffInDays}d ago`;
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Esc to close modals or reset focus
            if (e.key === 'Escape') {
                // Close any open modals or clear focus
                const activeElement = document.activeElement;
                if (activeElement && activeElement.blur) {
                    activeElement.blur();
                }
            }
        });
        
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showToast('An unexpected error occurred', 'error');
        });
        
        // Handle online/offline status
        window.addEventListener('online', function() {
            showToast('Connection restored', 'success');
        });
        
        window.addEventListener('offline', function() {
            showToast('Connection lost', 'warning');
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>